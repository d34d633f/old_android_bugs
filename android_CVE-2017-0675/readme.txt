Android libhevc out of bounds read

Test device
$ adb shell getprop ro.build.description
aosp_bullhead-userdebug 7.1.1 N4F26I eng.ffu.20170112.053429 test-keys


How to test:
1) compile libhevc with ASAN, also compile stagefright binary

2) copy mp4 file to device
$ adb push 1.mp4 /data/local/tmp

3) run stagefright decoder:
<phone>$ stagefright -s /data/local/tmp/1.mp4

ASAN log:

AddressSanitizer: heap-buffer-overflow on address 0xe730d1aa at pc 0xed1f2c34 bp 0xeacff1a8 sp 0xeacfed74
04-16 07:27:38.139  7988  8007 I         : 
04-16 07:27:38.140  7988  8007 I         : 
04-16 07:27:38.140  7988  8007 I         : READ of size 3060 at 0xe730d1aa thread T2 (le.hevc.decoder)
04-16 07:27:38.140  7988  8007 I         : 
04-16 07:27:38.212  7988  8007 I         :     #0 0xed1f2c33 in __asan_memcpy (/system/lib/libclang_rt.asan-arm-android.so+0x5cc33)
04-16 07:27:38.212  7988  8007 I         : 
04-16 07:27:38.232  7988  8007 I         :     #1 0xe92aefbf in ihevcd_copy_pps /proc/self/cwd/external/libhevc/decoder/ihevcd_parse_headers.c:1930:5
04-16 07:27:38.233  7988  8007 I         : 
04-16 07:27:38.234  7988  8007 I         :     #2 0xe92a5ceb in ihevcd_nal_unit /proc/self/cwd/external/libhevc/decoder/ihevcd_nal.c:447:17
04-16 07:27:38.234  7988  8007 I         : 
04-16 07:27:38.235  7988  8007 I         :     #3 0xe92a1e63 in ihevcd_decode /proc/self/cwd/external/libhevc/decoder/ihevcd_decode.c:604:15
04-16 07:27:38.235  7988  8007 I         : 
04-16 07:27:38.238  7988  8007 I         :     #4 0xe92a0497 in ihevcd_cxa_api_function /proc/self/cwd/external/libhevc/decoder/ihevcd_api.c:3552:19
04-16 07:27:38.238  7988  8007 I         : 
04-16 07:27:38.241  7988  8007 I         :     #5 0xe928df09 in android::SoftHEVC::onQueueFilled(unsigned int) /proc/self/cwd/frameworks/av/media/libstagefright/codecs/hevcdec/SoftHEVC.cpp:576:22
04-16 07:27:38.241  7988  8007 I         : 
04-16 07:27:38.244  7988  8007 I         :     #6 0xeca6a161 in android::SimpleSoftOMXComponent::onMessageReceived(android::sp<android::AMessage> const&) (/system/lib/libstagefright_omx.so+0x23161)
04-16 07:27:38.244  7988  8007 I         : 
04-16 07:27:38.245  7988  8007 I         :     #7 0xeca6b19b  (/system/lib/libstagefright_omx.so+0x2419b)
04-16 07:27:38.245  7988  8007 I         : 
04-16 07:27:38.247  7988  8007 I         :     #8 0xecb593d1 in android::AHandler::deliverMessage(android::sp<android::AMessage> const&) (/system/lib/libstagefright_foundation.so+0xf3d1)
04-16 07:27:38.247  7988  8007 I         : 
04-16 07:27:38.248  7988  8007 I         :     #9 0xecb5b653 in android::AMessage::deliver() (/system/lib/libstagefright_foundation.so+0x11653)
04-16 07:27:38.248  7988  8007 I         : 
04-16 07:27:38.248  7988  8007 I         :     #10 0xecb59f3b in android::ALooper::loop() (/system/lib/libstagefright_foundation.so+0xff3b)
04-16 07:27:38.248  7988  8007 I         : 
04-16 07:27:38.251  7479  7479 E QC-QMI  : qmi_client [7479]: unable to connect to server, errno=[2:No such file or directory], attempt=19
04-16 07:27:38.251  7988  8007 I         :     #11 0xed0b73c1 in android::Thread::_threadLoop(void*) (/system/lib/libutils.so+0xe3c1)
04-16 07:27:38.251  7988  8007 I         : 
04-16 07:27:38.260  7988  8007 I         :     #12 0xed122023 in __pthread_start(void*) (/system/lib/libc.so+0x47023)
04-16 07:27:38.260  7988  8007 I         : 
04-16 07:27:38.260  7988  8007 I         :     #13 0xed0f4e3d in __start_thread (/system/lib/libc.so+0x19e3d)
04-16 07:27:38.261  7988  8007 I         : 
04-16 07:27:38.261  7988  8007 I         : 
04-16 07:27:38.261  7988  8007 I         : 
04-16 07:27:38.261  7988  8007 I         : 0xe730d1aa is located 0 bytes to the right of 52650-byte region [0xe7300400,0xe730d1aa)
04-16 07:27:38.261  7988  8007 I         : 
04-16 07:27:38.262  7988  8007 I         : allocated by thread T2 (le.hevc.decoder) here:
04-16 07:27:38.262  7988  8007 I         : 
04-16 07:27:38.262  7988  8007 I         :     #0 0xed20b1ef in memalign (/system/lib/libclang_rt.asan-arm-android.so+0x751ef)
04-16 07:27:38.262  7988  8007 I         : 
04-16 07:27:38.263  7988  8007 I         :     #1 0xe929525b in ihevcd_allocate_dynamic_bufs /proc/self/cwd/external/libhevc/decoder/ihevcd_api.c:1504:14
04-16 07:27:38.263  7988  8007 I         : 
04-16 07:27:38.263  7988  8007 I         :     #2 0xe92a2223 in ihevcd_decode /proc/self/cwd/external/libhevc/decoder/ihevcd_decode.c:672:19
04-16 07:27:38.263  7988  8007 I         : 
04-16 07:27:38.263  7988  8007 I         :     #3 0xe92a0497 in ihevcd_cxa_api_function /proc/self/cwd/external/libhevc/decoder/ihevcd_api.c:3552:19
04-16 07:27:38.264  7988  8007 I         : 
04-16 07:27:38.264  7988  8007 I         :     #4 0xe928df09 in android::SoftHEVC::onQueueFilled(unsigned int) /proc/self/cwd/frameworks/av/media/libstagefright/codecs/hevcdec/SoftHEVC.cpp:576:22
04-16 07:27:38.264  7988  8007 I         : 
04-16 07:27:38.264  7988  8007 I         : 
04-16 07:27:38.264  7988  8007 I         : 
04-16 07:27:38.264  7988  8007 I         : Thread T2 (le.hevc.decoder) created by T1 (Binder:7988_1) here:
04-16 07:27:38.264  7988  8007 I         : 
04-16 07:27:38.265  7988  8007 I         :     #0 0xed1f24db in pthread_create (/system/lib/libclang_rt.asan-arm-android.so+0x5c4db)
04-16 07:27:38.265  7988  8007 I         : 
04-16 07:27:38.265  7988  8007 I         :     #1 0xed0b6ef9 in androidCreateRawThreadEtc (/system/lib/libutils.so+0xdef9)
04-16 07:27:38.265  7988  8007 I         : 
04-16 07:27:38.265  7988  8007 I         : 
04-16 07:27:38.265  7988  8007 I         : 
04-16 07:27:38.265  7988  8007 I         : Thread T1 (Binder:7988_1) created by T0 here:
04-16 07:27:38.265  7988  8007 I         : 
04-16 07:27:38.266  7988  8007 I         :     #0 0xed1f24db in pthread_create (/system/lib/libclang_rt.asan-arm-android.so+0x5c4db)
04-16 07:27:38.266  7988  8007 I         : 
04-16 07:27:38.266  7988  8007 I         :     #1 0xed0b6ef9 in androidCreateRawThreadEtc (/system/lib/libutils.so+0xdef9)
04-16 07:27:38.266  7988  8007 I         : 
04-16 07:27:38.266  7988  8007 I         :     #2 0xed0f1c4d in __libc_init (/system/lib/libc.so+0x16c4d)
04-16 07:27:38.266  7988  8007 I         : 
04-16 07:27:38.267  7988  8007 I         :     #3 0xffffffff  (<unknown module>)
04-16 07:27:38.267  7988  8007 I         : 
04-16 07:27:38.267  7988  8007 I         : 
04-16 07:27:38.267  7988  8007 I         : 
04-16 07:27:38.267  7988  8007 I         : SUMMARY: AddressSanitizer: heap-buffer-overflow (/system/lib/libclang_rt.asan-arm-android.so+0x5cc33) in __asan_memcpy
04-16 07:27:38.268  7988  8007 I         : 
04-16 07:27:38.268  7988  8007 I         : Shadow bytes around the buggy address:
04-16 07:27:38.268  7988  8007 I         :   0x1ce619e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
04-16 07:27:38.268  7988  8007 I         :   0x1ce619f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
04-16 07:27:38.268  7988  8007 I         :   0x1ce61a00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
04-16 07:27:38.268  7988  8007 I         :   0x1ce61a10: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
04-16 07:27:38.268  7988  8007 I         :   0x1ce61a20: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
04-16 07:27:38.268  7988  8007 I         : =>0x1ce61a30: 00 00 00 00 00[02]fa fa fa fa fa fa fa fa fa fa
04-16 07:27:38.268  7988  8007 I         :   0x1ce61a40: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
04-16 07:27:38.268  7988  8007 I         :   0x1ce61a50: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
04-16 07:27:38.268  7988  8007 I         :   0x1ce61a60: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
04-16 07:27:38.268  7988  8007 I         :   0x1ce61a70: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
04-16 07:27:38.268  7988  8007 I         :   0x1ce61a80: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
04-16 07:27:38.268  7988  8007 I         : Shadow byte legend (one shadow byte represents 8 application bytes):
04-16 07:27:38.268  7988  8007 I         :   Addressable:           00
04-16 07:27:38.268  7988  8007 I         :   Partially addressable: 01 02 03 04 05 06 07 
04-16 07:27:38.268  7988  8007 I         :   Heap left redzone:       fa
04-16 07:27:38.268  7988  8007 I         :   Heap right redzone:      fb
04-16 07:27:38.269  7988  8007 I         :   Freed heap region:       fd
04-16 07:27:38.269  7988  8007 I         :   Stack left redzone:      f1
04-16 07:27:38.269  7988  8007 I         :   Stack mid redzone:       f2
04-16 07:27:38.269  7988  8007 I         :   Stack right redzone:     f3
04-16 07:27:38.269  7988  8007 I         :   Stack partial redzone:   f4
04-16 07:27:38.269  7988  8007 I         :   Stack after return:      f5
04-16 07:27:38.269  7988  8007 I         :   Stack use after scope:   f8
04-16 07:27:38.269  7988  8007 I         :   Global redzone:          f9
04-16 07:27:38.269  7988  8007 I         :   Global init order:       f6
04-16 07:27:38.269  7988  8007 I         :   Poisoned by user:        f7
04-16 07:27:38.269  7988  8007 I         :   Container overflow:      fc
04-16 07:27:38.269  7988  8007 I         :   Array cookie:            ac
04-16 07:27:38.269  7988  8007 I         :   Intra object redzone:    bb
04-16 07:27:38.269  7988  8007 I         :   ASan internal:           fe
04-16 07:27:38.269  7988  8007 I         :   Left alloca redzone:     ca
04-16 07:27:38.269  7988  8007 I         :   Right alloca redzone:    cb
04-16 07:27:38.269  7988  8007 I         : 
04-16 07:27:38.269  7988  8007 I         : ==7988==ABORTING
04-16 07:27:38.269  7988  8007 I         : 
04-16 07:27:38.271   474   493 E QC-QMI  : qmi_client [474]: unable to connect to server, errno=[2:No such file or directory], attempt=12
04-16 07:27:38.276   387   387 I ServiceManager: service 'media.codec' died
04-16 07:27:38.276  8001  8006 E ACodec  : OMX/mediaserver died, signalling error!
04-16 07:27:38.277  8001  8006 E ACodec  : signalError(omxError 0x8000100d, internalError -32)
04-16 07:27:38.277  8001  8005 E MediaCodec: Codec reported err 0xffffffe0, actionCode 0, while in state 6

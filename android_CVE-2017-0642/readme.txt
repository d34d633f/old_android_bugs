Android libhevc use after free 

Test device
$ adb shell getprop ro.build.description
aosp_bullhead-userdebug 7.1.1 N4F26I eng.ffu.20170112.053429 test-keys


How to test:
1) compile libhevc with ASAN, also compile stagefright binary

2) copy mp4 file to device
$ adb push 1.mp4 /data/local/tmp

3) run stagefright decoder:
<phone>$ stagefright -s /data/local/tmp/1.mp4

ASAN log:

AddressSanitizer: heap-use-after-free on address 0xe2802a04 at pc 0xe37dc674 bp 0xe3ffebd8 sp 0xe3ffebd0
04-17 04:46:04.060  2669 14855 I         : 
04-17 04:46:04.060  2669 14855 I         : 
04-17 04:46:04.060  2669 14855 I         : READ of size 4 at 0xe2802a04 thread T11560 (le.hevc.decoder)
04-17 04:46:04.060  2669 14855 I         : 
04-17 04:46:04.133  2669 14855 I         :     #0 0xe37dc673 in ihevcd_ref_list /proc/self/cwd/external/libhevc/decoder/ihevcd_ref_list.c:508:44
04-17 04:46:04.133  2669 14855 I         : 
04-17 04:46:04.134  2669 14855 I         :     #1 0xe37b2097 in ihevcd_parse_slice_header /proc/self/cwd/external/libhevc/decoder/ihevcd_parse_slice_header.c:913:13
04-17 04:46:04.134  2669 14855 I         : 
04-17 04:46:04.134  2669 14855 I         :     #2 0xe37a5ba3 in ihevcd_nal_unit /proc/self/cwd/external/libhevc/decoder/ihevcd_nal.c:398:19
04-17 04:46:04.134  2669 14855 I         : 
04-17 04:46:04.135  2669 14855 I         :     #3 0xe37a1e63 in ihevcd_decode /proc/self/cwd/external/libhevc/decoder/ihevcd_decode.c:604:15
04-17 04:46:04.135  2669 14855 I         : 
04-17 04:46:04.136  2669 14855 I         :     #4 0xe37a0497 in ihevcd_cxa_api_function /proc/self/cwd/external/libhevc/decoder/ihevcd_api.c:3552:19
04-17 04:46:04.136  2669 14855 I         : 
04-17 04:46:04.137  2669 14855 I         :     #5 0xe378df09 in android::SoftHEVC::onQueueFilled(unsigned int) /proc/self/cwd/frameworks/av/media/libstagefright/codecs/hevcdec/SoftHEVC.cpp:576:22
04-17 04:46:04.137  2669 14855 I         : 
04-17 04:46:04.139  2669 14855 I         :     #6 0xe70c6161 in android::SimpleSoftOMXComponent::onMessageReceived(android::sp<android::AMessage> const&) (/system/lib/libstagefright_omx.so+0x23161)
04-17 04:46:04.139  2669 14855 I         : 
04-17 04:46:04.139  2669 14855 I         :     #7 0xe70c719b  (/system/lib/libstagefright_omx.so+0x2419b)
04-17 04:46:04.139  2669 14855 I         : 
04-17 04:46:04.140  2669 14855 I         :     #8 0xe6ff83d1 in android::AHandler::deliverMessage(android::sp<android::AMessage> const&) (/system/lib/libstagefright_foundation.so+0xf3d1)
04-17 04:46:04.140  2669 14855 I         : 
04-17 04:46:04.140  2669 14855 I         :     #9 0xe6ffa653 in android::AMessage::deliver() (/system/lib/libstagefright_foundation.so+0x11653)
04-17 04:46:04.140  2669 14855 I         : 
04-17 04:46:04.140  2669 14855 I         :     #10 0xe6ff8f3b in android::ALooper::loop() (/system/lib/libstagefright_foundation.so+0xff3b)
04-17 04:46:04.140  2669 14855 I         : 
04-17 04:46:04.141  2669 14855 I         :     #11 0xe7aac3c1 in android::Thread::_threadLoop(void*) (/system/lib/libutils.so+0xe3c1)
04-17 04:46:04.141  2669 14855 I         : 
04-17 04:46:04.146  2669 14855 I         :     #12 0xe7b7e023 in __pthread_start(void*) (/system/lib/libc.so+0x47023)
04-17 04:46:04.146  2669 14855 I         : 
04-17 04:46:04.146  2669 14855 I         :     #13 0xe7b50e3d in __start_thread (/system/lib/libc.so+0x19e3d)
04-17 04:46:04.146  2669 14855 I         : 
04-17 04:46:04.146  2669 14855 I         : 
04-17 04:46:04.146  2669 14855 I         : 
04-17 04:46:04.147  2669 14855 I         : 0xe2802a04 is located 20996 bytes inside of 1048576-byte region [0xe27fd800,0xe28fd800)
04-17 04:46:04.147  2669 14855 I         : 
04-17 04:46:04.147  2669 14855 I         : freed by thread T138 (Binder:2669_5) here:
04-17 04:46:04.147  2669 14855 I         : 
04-17 04:46:04.149  2669 14855 I         :     #0 0xe74ed90f in __interceptor_free (/system/lib/libclang_rt.asan-arm-android.so+0x7490f)
04-17 04:46:04.149  2669 14855 I         : 
04-17 04:46:04.155  2669 14855 I         :     #1 0xe390064b in __cxa_finalize (/system/lib/libstagefright.so+0x7f64b)
04-17 04:46:04.155  2669 14855 I         : 
04-17 04:46:04.155  2669 14855 I         :     #2 0xe390c4db in android::ACodec::configureCodec(char const*, android::sp<android::AMessage> const&) (/system/lib/libstagefright.so+0x8b4db)
04-17 04:46:04.155  2669 14855 I         : 
04-17 04:46:04.156  2669 14855 I         :     #3 0xe38f96b3 in __cxa_finalize (/system/lib/libstagefright.so+0x786b3)
04-17 04:46:04.156  2669 14855 I         : 
04-17 04:46:04.156  2669 14855 I         : 
04-17 04:46:04.156  2669 14855 I         : 
04-17 04:46:04.156  2669 14855 I         : previously allocated by thread T1 (Binder:2669_1) here:
04-17 04:46:04.156  2669 14855 I         : 
04-17 04:46:04.156  2669 14855 I         :     #0 0xe74ee1ef in memalign (/system/lib/libclang_rt.asan-arm-android.so+0x751ef)
04-17 04:46:04.156  2669 14855 I         : 
04-17 04:46:04.156  2669 14855 I         :     #1 0xe38fe9c7 in __cxa_finalize (/system/lib/libstagefright.so+0x7d9c7)
04-17 04:46:04.156  2669 14855 I         : 
04-17 04:46:04.156  2669 14855 I         :     #2 0xe390c43b in android::ACodec::setComponentRole(android::sp<android::IOMX> const&, unsigned int, char const*) (/system/lib/libstagefright.so+0x8b43b)
04-17 04:46:04.156  2669 14855 I         : 
04-17 04:46:04.157  2669 14855 I         :     #3 0xe38f945d in __cxa_finalize (/system/lib/libstagefright.so+0x7845d)
04-17 04:46:04.157  2669 14855 I         : 
04-17 04:46:04.157  2669 14855 I         : 
04-17 04:46:04.157  2669 14855 I         : 
04-17 04:46:04.157  2669 14855 I         : Thread T11560 (le.hevc.decoder) created by T26 (Binder:2669_3) here:
04-17 04:46:04.157  2669 14855 I         : 
04-17 04:46:04.157  2669 14855 I         :     #0 0xe74d54db in pthread_create (/system/lib/libclang_rt.asan-arm-android.so+0x5c4db)
04-17 04:46:04.157  2669 14855 I         : 
04-17 04:46:04.157  2669 14855 I         :     #1 0xe7aabef9 in androidCreateRawThreadEtc (/system/lib/libutils.so+0xdef9)
04-17 04:46:04.157  2669 14855 I         : 
04-17 04:46:04.157  2669 14855 I         : 
04-17 04:46:04.157  2669 14855 I         : 
04-17 04:46:04.157  2669 14855 I         : Thread T26 (Binder:2669_3) created by T4 (Binder:2669_2) here:
04-17 04:46:04.157  2669 14855 I         : 
04-17 04:46:04.158  2669 14855 I         :     #0 0xe74d54db in pthread_create (/system/lib/libclang_rt.asan-arm-android.so+0x5c4db)
04-17 04:46:04.158  2669 14855 I         : 
04-17 04:46:04.158  2669 14855 I         :     #1 0xe7aabef9 in androidCreateRawThreadEtc (/system/lib/libutils.so+0xdef9)
04-17 04:46:04.158  2669 14855 I         : 
04-17 04:46:04.158  2669 14855 I         : 
04-17 04:46:04.158  2669 14855 I         : 
04-17 04:46:04.158  2669 14855 I         : Thread T4 (Binder:2669_2) created by T0 here:
04-17 04:46:04.158  2669 14855 I         : 
04-17 04:46:04.158  2669 14855 I         :     #0 0xe74d54db in pthread_create (/system/lib/libclang_rt.asan-arm-android.so+0x5c4db)
04-17 04:46:04.158  2669 14855 I         : 
04-17 04:46:04.158  2669 14855 I         :     #1 0xe7aabef9 in androidCreateRawThreadEtc (/system/lib/libutils.so+0xdef9)
04-17 04:46:04.158  2669 14855 I         : 
04-17 04:46:04.159  2669 14855 I         :     #2 0xe7b4dc4d in __libc_init (/system/lib/libc.so+0x16c4d)
04-17 04:46:04.159  2669 14855 I         : 
04-17 04:46:04.159  2669 14855 I         :     #3 0xffffffff  (<unknown module>)
04-17 04:46:04.159  2669 14855 I         : 
04-17 04:46:04.159  2669 14855 I         : 
04-17 04:46:04.159  2669 14855 I         : 
04-17 04:46:04.160  2669 14855 I         : Thread T138 (Binder:2669_5) created by T26 (Binder:2669_3) here:
04-17 04:46:04.160  2669 14855 I         : 
04-17 04:46:04.160  2669 14855 I         :     #0 0xe74d54db in pthread_create (/system/lib/libclang_rt.asan-arm-android.so+0x5c4db)
04-17 04:46:04.160  2669 14855 I         : 
04-17 04:46:04.160  2669 14855 I         :     #1 0xe7aabef9 in androidCreateRawThreadEtc (/system/lib/libutils.so+0xdef9)
04-17 04:46:04.160  2669 14855 I         : 
04-17 04:46:04.160  2669 14855 I         : 
04-17 04:46:04.160  2669 14855 I         : 
04-17 04:46:04.160  2669 14855 I         : Thread T1 (Binder:2669_1) created by T0 here:
04-17 04:46:04.160  2669 14855 I         : 
04-17 04:46:04.160  2669 14855 I         :     #0 0xe74d54db in pthread_create (/system/lib/libclang_rt.asan-arm-android.so+0x5c4db)
04-17 04:46:04.160  2669 14855 I         : 
04-17 04:46:04.161  2669 14855 I         :     #1 0xe7aabef9 in androidCreateRawThreadEtc (/system/lib/libutils.so+0xdef9)
04-17 04:46:04.161  2669 14855 I         : 
04-17 04:46:04.161  2669 14855 I         :     #2 0xe7b4dc4d in __libc_init (/system/lib/libc.so+0x16c4d)
04-17 04:46:04.161  2669 14855 I         : 
04-17 04:46:04.161  2669 14855 I         :     #3 0xffffffff  (<unknown module>)
04-17 04:46:04.161  2669 14855 I         : 
04-17 04:46:04.161  2669 14855 I         : 
04-17 04:46:04.161  2669 14855 I         : 
04-17 04:46:04.162  2669 14855 I         : SUMMARY: AddressSanitizer: heap-use-after-free /proc/self/cwd/external/libhevc/decoder/ihevcd_ref_list.c:508:44 in ihevcd_ref_list
04-17 04:46:04.162  2669 14855 I         : 
04-17 04:46:04.162  2669 14855 I         : Shadow bytes around the buggy address:
04-17 04:46:04.162  2669 14855 I         :   0x1c5004f0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
04-17 04:46:04.162  2669 14855 I         :   0x1c500500: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
04-17 04:46:04.162  2669 14855 I         :   0x1c500510: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
04-17 04:46:04.162  2669 14855 I         :   0x1c500520: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
04-17 04:46:04.162  2669 14855 I         :   0x1c500530: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
04-17 04:46:04.162  2669 14855 I         : =>0x1c500540:[fd]fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
04-17 04:46:04.162  2669 14855 I         :   0x1c500550: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
04-17 04:46:04.162  2669 14855 I         :   0x1c500560: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
04-17 04:46:04.162  2669 14855 I         :   0x1c500570: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
04-17 04:46:04.162  2669 14855 I         :   0x1c500580: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
04-17 04:46:04.162  2669 14855 I         :   0x1c500590: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
04-17 04:46:04.162  2669 14855 I         : Shadow byte legend (one shadow byte represents 8 application bytes):
04-17 04:46:04.162  2669 14855 I         :   Addressable:           00
04-17 04:46:04.162  2669 14855 I         :   Partially addressable: 01 02 03 04 05 06 07 
04-17 04:46:04.162  2669 14855 I         :   Heap left redzone:       fa
04-17 04:46:04.162  2669 14855 I         :   Heap right redzone:      fb
04-17 04:46:04.162  2669 14855 I         :   Freed heap region:       fd
04-17 04:46:04.162  2669 14855 I         :   Stack left redzone:      f1
04-17 04:46:04.162  2669 14855 I         :   Stack mid redzone:       f2
04-17 04:46:04.162  2669 14855 I         :   Stack right redzone:     f3
04-17 04:46:04.162  2669 14855 I         :   Stack partial redzone:   f4
04-17 04:46:04.162  2669 14855 I         :   Stack after return:      f5
04-17 04:46:04.162  2669 14855 I         :   Stack use after scope:   f8
04-17 04:46:04.163  2669 14855 I         :   Global redzone:          f9
04-17 04:46:04.163  2669 14855 I         :   Global init order:       f6
04-17 04:46:04.163  2669 14855 I         :   Poisoned by user:        f7
04-17 04:46:04.163  2669 14855 I         :   Container overflow:      fc
04-17 04:46:04.163  2669 14855 I         :   Array cookie:            ac
04-17 04:46:04.163  2669 14855 I         :   Intra object redzone:    bb
04-17 04:46:04.163  2669 14855 I         :   ASan internal:           fe
04-17 04:46:04.163  2669 14855 I         :   Left alloca redzone:     ca
04-17 04:46:04.163  2669 14855 I         :   Right alloca redzone:    cb
04-17 04:46:04.163  2669 14855 I         : 
04-17 04:46:04.163  2669 14855 I         : ==2669==ABORTING
04-17 04:46:04.163  2669 14855 I         : 
04-17 04:46:04.177 12047 12047 E QC-QMI  : qmi_client [12047]: unable to connect to server, errno=[2:No such file or directory], attempt=21
04-17 04:46:04.190 14849 14854 E ACodec  : OMX/mediaserver died, signalling error!
04-17 04:46:04.190 14849 14854 E ACodec  : signalError(omxError 0x8000100d, internalError -32)
04-17 04:46:04.190   389   389 I ServiceManager: service 'media.codec' died
04-17 04:46:04.190 14849 14853 E MediaCodec: Codec reported err 0xffffffe0, actionCode 0, while in state 6
04-17 04:46:04.288 15045 15045 I mediacodec: @@@ mediacodecservice starting

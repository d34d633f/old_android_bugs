Android opencv3 bmp heap overflow


1) compile test application t1.cpp with ASAN

2) generate malformed bmp file:
$ ./gen.py

3) run t1
$./t1 1.bmp

=================================================================
==27283==ERROR: AddressSanitizer: heap-buffer-overflow on address 0xb0000b14 at pc 0x80a440f bp 0xbfd06058 sp 0xbfd05c38
WRITE of size 32718 at 0xb0000b14 thread T0
    #0 0x80a440e in memcpy (/dist/opencv/test/t1+0x80a440e)
    #1 0xb7142008 in cv::RLByteStream::getBytes(void*, int) (/usr/local/lib/libopencv_imgcodecs.so.3.2+0x29008)
    #2 0xb7134d9c in cv::BmpDecoder::readHeader() (/usr/local/lib/libopencv_imgcodecs.so.3.2+0x1bd9c)
    #3 0xb71289c8 in cv::imread_(cv::String const&, int, int, cv::Mat*) (/usr/local/lib/libopencv_imgcodecs.so.3.2+0xf9c8)
    #4 0xb71294e0 in cv::imread(cv::String const&, int) (/usr/local/lib/libopencv_imgcodecs.so.3.2+0x104e0)
    #5 0x80cfd1c in main /dist/opencv/test/t1.cpp:15
    #6 0xb6703a82 (/lib/i386-linux-gnu/libc.so.6+0x19a82)
    #7 0x80cf774 in _start (/dist/opencv/test/t1+0x80cf774)

0xb0000b14 is located 0 bytes to the right of 1172-byte region [0xb0000680,0xb0000b14)
allocated by thread T0 here:
    #0 0x80b8b21 in operator new(unsigned int) (/dist/opencv/test/t1+0x80b8b21)
    #1 0xb7135720 in cv::BmpDecoder::newDecoder() const (/usr/local/lib/libopencv_imgcodecs.so.3.2+0x1c720)
    #2 0xb7128932 in cv::imread_(cv::String const&, int, int, cv::Mat*) (/usr/local/lib/libopencv_imgcodecs.so.3.2+0xf932)
    #3 0xb71294e0 in cv::imread(cv::String const&, int) (/usr/local/lib/libopencv_imgcodecs.so.3.2+0x104e0)
    #4 0x4

SUMMARY: AddressSanitizer: heap-buffer-overflow ??:0 memcpy
Shadow bytes around the buggy address:
  0x36000110: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x36000120: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x36000130: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x36000140: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x36000150: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
=>0x36000160: 00 00[04]fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x36000170: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x36000180: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x36000190: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x360001a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x360001b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:     fa
  Heap right redzone:    fb
  Freed heap region:     fd
  Stack left redzone:    f1
  Stack mid redzone:     f2
  Stack right redzone:   f3
  Stack partial redzone: f4
  Stack after return:    f5
  Stack use after scope: f8
  Global redzone:        f9
  Global init order:     f6
  Poisoned by user:      f7
  ASan internal:         fe
==27283==ABORTING



To test it on a device:
1) adb push sample.bmp /data/local/tmp/sample.bmp
2) adb install test.apk
3) run imtest app

adb logcat output:


03-23 15:00:29.355  3323  3335 F libc    : Fatal signal 11 (SIGSEGV), code 1, fault addr 0x78787910 in tid 3335 (Binder:3323_1)
03-23 15:00:29.356  1247  1247 W         : debuggerd: handling request: pid=3323 uid=10081 gid=10081 tid=3335
03-23 15:00:29.416  3341  3341 F DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***
03-23 15:00:29.416  3341  3341 F DEBUG   : Build fingerprint: 'Android/sdk_google_phone_x86/generic_x86:7.1.1/NYC/3756122:userdebug/test-keys'
03-23 15:00:29.416  3341  3341 F DEBUG   : Revision: '0'
03-23 15:00:29.416  3341  3341 F DEBUG   : ABI: 'x86'
03-23 15:00:29.416  3341  3341 F DEBUG   : pid: 3323, tid: 3335, name: Binder:3323_1  >>> com.ivd.test.imtest <<<
03-23 15:00:29.416  3341  3341 F DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x78787910
03-23 15:00:29.416  3341  3341 F DEBUG   :     eax a008d410  ebx ac4abac0  ecx 001006f6  edx 78787878
03-23 15:00:29.416  3341  3341 F DEBUG   :     esi a008d410  edi a00a0a40
03-23 15:00:29.416  3341  3341 F DEBUG   :     xcs 00000073  xds 0000007b  xes 0000007b  xfs 0000003b  xss 0000007b
03-23 15:00:29.416  3341  3341 F DEBUG   :     eip ac371b90  ebp abbb0e40  esp aa7c1500  flags 00010286
03-23 15:00:29.430  2208  2208 I OptInState: There is a new client and it does not support opt-in. Dropping request.
03-23 15:00:29.431  1593  1616 D gralloc_ranchu: gralloc_unregister_buffer: exiting HostConnection (is buffer-handling thread)
03-23 15:00:29.438  2208  2208 I MicroDetectionWorker: Micro detection mode: [mDetectionMode: [1]].
03-23 15:00:29.438  2208  2208 I AudioController: Using mInputStreamFactoryBuilder
03-23 15:00:29.439  3341  3341 F DEBUG   : 
03-23 15:00:29.439  3341  3341 F DEBUG   : backtrace:
03-23 15:00:29.439  3341  3341 F DEBUG   :     #00 pc 00079b90  /system/lib/libandroid_runtime.so (_ZN7_JNIEnv17CallBooleanMethodEP8_jobjectP10_jmethodIDz+36)
03-23 15:00:29.439  3341  3341 F DEBUG   :     #01 pc 000e274e  /system/lib/libandroid_runtime.so (_ZN11JavaBBinder10onTransactEjRKN7android6ParcelEPS1_j+194)
03-23 15:00:29.440  3341  3341 F DEBUG   :     #02 pc 000390b6  /system/lib/libbinder.so (_ZN7android7BBinder8transactEjRKNS_6ParcelEPS1_j+118)
03-23 15:00:29.440  3341  3341 F DEBUG   :     #03 pc 00047f98  /system/lib/libbinder.so (_ZN7android14IPCThreadState14executeCommandEi+1208)
03-23 15:00:29.440  3341  3341 F DEBUG   :     #04 pc 000479bb  /system/lib/libbinder.so (_ZN7android14IPCThreadState20getAndExecuteCommandEv+171)
03-23 15:00:29.440  3341  3341 F DEBUG   :     #05 pc 000481ff  /system/lib/libbinder.so (_ZN7android14IPCThreadState14joinThreadPoolEb+95)
03-23 15:00:29.440  3341  3341 F DEBUG   :     #06 pc 0006effe  /system/lib/libbinder.so (_ZN7android10PoolThread10threadLoopEv+46)
03-23 15:00:29.440  3341  3341 F DEBUG   :     #07 pc 00012095  /system/lib/libutils.so (_ZN7android6Thread11_threadLoopEPv+309)
03-23 15:00:29.440  3341  3341 F DEBUG   :     #08 pc 0007098b  /system/lib/libandroid_runtime.so (_ZN7android14AndroidRuntime15javaThreadShellEPv+111)
03-23 15:00:29.440  3341  3341 F DEBUG   :     #09 pc 00011883  /system/lib/libutils.so (_ZN13thread_data_t10trampolineEPKS_+259)
03-23 15:00:29.440  3341  3341 F DEBUG   :     #10 pc 00074fe2  /system/lib/libc.so (_ZL15__pthread_startPv+210)
03-23 15:00:29.440  3341  3341 F DEBUG   :     #11 pc 0002029e  /system/lib/libc.so (__start_thread+30)
03-23 15:00:29.440  3341  3341 F DEBUG   :     #12 pc 0001e076  /system/lib/libc.so (__bionic_clone+70)
